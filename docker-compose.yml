version: '3.3'

services:
  node:
    image: node:latest
    ports:
      - "443:443"
    volumes:
      - /opt/TipocaCity/kamino-frontend/:/opt/kamino
    networks:
      - webnet
    depends_on:
      - api
    working_dir: /opt/kamino
    command: sh -c 'npm i && npm run -- dev'

  api:
    image: golang:latest
    ports:
      - "8080:8080"
    networks:
      - webnet
    # Here you can mount the directory where your Go API code is located
    volumes:
      - /opt/TipocaCity/cyclone:/opt/cyclone
    working_dir: /opt/cyclone
    command: 
      - /bin/bash
      - -c 
      - | 
        dpkg -i ./powershell-deb/packages-microsoft-prod.deb
        apt update 
        apt install powershell -y
        pwsh -c "Install-Module -Name VMware.PowerCLI -Force"
        cp -r ./pwsh/Kamino/ /root/.local/share/powershell/Modules/
        pwsh -c "Import-Module Kamino"
        pwsh -c "Set-PowerCLIConfiguration -InvalidCertificateAction Ignore -Scope AllUsers -Confirm:0"
        pwsh -c "Set-PowerCLIConfiguration -ParticipateInCEIP:0 -Scope AllUsers -Confirm:0"
        pwsh -c "[PSCredential]::New('$vcenterusername', (ConvertTo-SecureString -AsPlainText '$vcenterpassword' -Force)) | Export-Clixml -Path ./lib/creds/vsphere_cred.xml"
        go run .

  ldap:
    image: osixia/openldap:latest
    ports:
      - "389:389"
    environment:
      LDAP_ORGANISATION: "Kamino Labs"
      LDAP_DOMAIN: "kamino.labs"
      LDAP_ADMIN_PASSWORD: "changeme"
    networks:
      - webnet
    # LDAP needs a volume to persist data
    volumes:
      - ldap_data:/var/lib/ldap
      - ldap_slapd:/etc/ldap/slapd.d

networks:
  webnet:

volumes:
  ldap_data:
  ldap_slapd: